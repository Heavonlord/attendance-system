{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>Mark Attendance - {{ course.name }}</h2>
        <p class="text-muted">Course Code: {{ course.code }}</p>
        
        <!-- VOICE RECOGNITION CARD - ONLY ONE -->
        <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="mb-2 mb-md-0">
                        <h5 class="mb-1" style="color: white;">
                            üé§ Voice-Assisted Marking 
                            <span class="badge bg-warning text-dark">PREMIUM</span>
                        </h5>
                        <p class="mb-0 small" style="color: rgba(255,255,255,0.9);">
                            üí° Say: "101 present" or "102 absent" (numbers work best!)
                        </p>
                    </div>
                    <button type="button" id="voiceBtn" class="btn btn-light" onclick="toggleVoice()">
                        üé§ Start Voice Mode
                    </button>
                </div>
                
                <div id="voiceStatus" class="mt-3" style="display:none;">
                    <div class="alert alert-light mb-2">
                        <strong>üé§ LISTENING</strong> - Speak clearly and wait 2 seconds
                    </div>
                    
                    <div id="voiceTranscript" class="p-3 border rounded" style="background: white; max-height: 200px; overflow-y: auto; font-family: monospace; color: #333; font-size: 0.9em;">
                        <small class="text-muted">üé§ Ready! Start speaking...</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ATTENDANCE FORM -->
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    <div class="mb-4">
                        <label for="date" class="form-label">Select Date</label>
                        <input type="date" class="form-control" id="date" name="date" 
                               value="{{ today }}" max="{{ today }}" required>
                    </div>
                    
                    <h4 class="mb-3">Students</h4>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-success me-2" onclick="markAll('present')">
                            Mark All Present
                        </button>
                        <button type="button" class="btn btn-danger" onclick="markAll('absent')">
                            Mark All Absent
                        </button>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>‚å®Ô∏è Keyboard Shortcuts:</strong>
                        Click on any student, then: <kbd>P</kbd> = Present | <kbd>A</kbd> = Absent | <kbd>L</kbd> = Late
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Roll No / Name</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr>
                                    <td>
                                        <strong class="text-primary">{{ student.roll_no or 'N/A' }}</strong>
                                        <br>
                                        <small class="text-muted">{{ student.username }}</small>
                                    </td>
                                    <td>{{ student.email }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" 
                                                   name="status_{{ student.id }}" 
                                                   id="present_{{ student.id }}" 
                                                   value="present" checked>
                                            <label class="btn btn-outline-success btn-sm" 
                                                   for="present_{{ student.id }}">
                                                Present
                                            </label>
                                            
                                            <input type="radio" class="btn-check" 
                                                   name="status_{{ student.id }}" 
                                                   id="absent_{{ student.id }}" 
                                                   value="absent">
                                            <label class="btn btn-outline-danger btn-sm" 
                                                   for="absent_{{ student.id }}">
                                                Absent
                                            </label>
                                            
                                            <input type="radio" class="btn-check" 
                                                   name="status_{{ student.id }}" 
                                                   id="late_{{ student.id }}" 
                                                   value="late">
                                            <label class="btn btn-outline-warning btn-sm" 
                                                   for="late_{{ student.id }}">
                                                Late
                                            </label>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if not students %}
                    <div class="alert alert-warning">
                        No students enrolled in this course. 
                        <a href="{{ url_for('main.manage_enrollments', course_id=course.id) }}">Enroll students first</a>
                    </div>
                    {% endif %}
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            üíæ Save Attendance
                        </button>
                        <a href="{{ url_for('main.teacher_dashboard') }}" class="btn btn-secondary btn-lg">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let recognition;
let isListening = false;

function markAll(status) {
    document.querySelectorAll(`input[value="${status}"]`).forEach(radio => {
        radio.checked = true;
    });
}

function toggleVoice() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('‚ö†Ô∏è Voice recognition not supported.\n\nPlease use Chrome or Edge browser.');
        return;
    }
    
    if (isListening) {
        stopVoice();
    } else {
        startVoice();
    }
}

function startVoice() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = 'en-IN';
    
    recognition.onstart = function() {
        isListening = true;
        document.getElementById('voiceBtn').innerHTML = 'üõë Stop Voice';
        document.getElementById('voiceBtn').classList.remove('btn-light');
        document.getElementById('voiceBtn').classList.add('btn-danger');
        document.getElementById('voiceStatus').style.display = 'block';
        document.getElementById('voiceTranscript').innerHTML = '<small class="text-success">üé§ Listening... speak now!</small><br>';
    };
    
    recognition.onresult = function(event) {
        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
        const time = new Date().toLocaleTimeString();
        
        document.getElementById('voiceTranscript').innerHTML = 
            `<span class="text-primary"><strong>[${time}]</strong> "${transcript}"</span><br>` + 
            document.getElementById('voiceTranscript').innerHTML;
        
        processVoiceCommand(transcript);
    };
    
    recognition.onerror = function(event) {
        document.getElementById('voiceTranscript').innerHTML = 
            `<span class="text-danger">‚ùå Error: ${event.error}</span><br>` + 
            document.getElementById('voiceTranscript').innerHTML;
    };
    
    recognition.onend = function() {
        if (isListening) {
            recognition.start();
        }
    };
    
    recognition.start();
}

function stopVoice() {
    if (recognition) {
        isListening = false;
        recognition.stop();
        document.getElementById('voiceBtn').innerHTML = 'üé§ Start Voice Mode';
        document.getElementById('voiceBtn').classList.remove('btn-danger');
        document.getElementById('voiceBtn').classList.add('btn-light');
    }
}

function processVoiceCommand(transcript) {
    // Extract numbers and status
    const numberMatch = transcript.match(/(\d+)/);
    const statusMatch = transcript.match(/(present|absent|late)/i);
    
    if (!numberMatch || !statusMatch) {
        document.getElementById('voiceTranscript').innerHTML = 
            `<span class="text-warning">‚ö†Ô∏è Say: "[number] [present/absent/late]"</span><br>` + 
            document.getElementById('voiceTranscript').innerHTML;
        return;
    }
    
    const number = numberMatch[1];
    const status = statusMatch[1].toLowerCase();
    
    // Find student with this number in roll_no
    const rows = document.querySelectorAll('tbody tr');
    let found = false;
    
    rows.forEach(row => {
        const rollCell = row.querySelector('td:first-child strong');
        if (rollCell) {
            const rollText = rollCell.textContent.trim();
            
            // Check if roll number contains this number
            if (rollText.includes(number)) {
                const studentName = row.querySelector('td:first-child small').textContent.trim();
                const firstRadio = row.querySelector('input[type="radio"]');
                const studentId = firstRadio.name.split('_')[1];
                const radioId = `${status}_${studentId}`;
                
                document.getElementById(radioId).checked = true;
                
                // Flash effect
                row.classList.add(status === 'present' ? 'table-success' : status === 'absent' ? 'table-danger' : 'table-warning');
                setTimeout(() => row.classList.remove('table-success', 'table-danger', 'table-warning'), 1500);
                
                document.getElementById('voiceTranscript').innerHTML = 
                    `<span class="text-success"><strong>‚úì</strong> ${rollText} (${studentName}) ‚Üí <strong>${status.toUpperCase()}</strong></span><br>` + 
                    document.getElementById('voiceTranscript').innerHTML;
                
                found = true;
            }
        }
    });
    
    if (!found) {
        document.getElementById('voiceTranscript').innerHTML = 
            `<span class="text-danger">‚ùå Number "${number}" not found</span><br>` + 
            document.getElementById('voiceTranscript').innerHTML;
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' && e.target.type !== 'radio') return;
    if (e.ctrlKey || e.metaKey || e.altKey) return;
    
    const focusedRow = document.activeElement.closest('tr');
    if (!focusedRow) return;
    
    const firstRadio = focusedRow.querySelector('input[type="radio"]');
    if (!firstRadio) return;
    
    const studentId = firstRadio.name.split('_')[1];
    let nextRow = null;
    
    if (e.key === 'p' || e.key === 'P') {
        document.getElementById(`present_${studentId}`).checked = true;
        focusedRow.classList.add('table-success');
        setTimeout(() => focusedRow.classList.remove('table-success'), 500);
        nextRow = focusedRow.nextElementSibling;
        e.preventDefault();
    } else if (e.key === 'a' || e.key === 'A') {
        document.getElementById(`absent_${studentId}`).checked = true;
        focusedRow.classList.add('table-danger');
        setTimeout(() => focusedRow.classList.remove('table-danger'), 500);
        nextRow = focusedRow.nextElementSibling;
        e.preventDefault();
    } else if (e.key === 'l' || e.key === 'L') {
        document.getElementById(`late_${studentId}`).checked = true;
        focusedRow.classList.add('table-warning');
        setTimeout(() => focusedRow.classList.remove('table-warning'), 500);
        nextRow = focusedRow.nextElementSibling;
        e.preventDefault();
    }
    
    if (nextRow) {
        const nextRadio = nextRow.querySelector('input[type="radio"]');
        if (nextRadio) nextRadio.focus();
    }
});
</script>
{% endblock %}
